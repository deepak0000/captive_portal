{"name":"Secure network","tagline":"Captive portal creation","body":"REQUIREMENTS :\r\n* Raspberry pi\r\n* WIFI dongle or ethernet to USB adapter\r\n* Router\r\n\r\n<p><strong>First things first, install Raspbian.</strong></p>\r\n<p><a href=\"https://www.raspberrypi.org/downloads/\" target=\"_blank\">Raspberry Pi downloads</a></p>\r\n<p>Complete the setup.</p>\r\n<p>Now, we need to install some software on the Raspberry pi. We first perform a software update:</p>\r\n<p><em>$ sudo apt-get update &amp;&amp; sudo apt-get upgrade</em></p>\r\n<p>We&#8217;ll be using CoovaChilli to create the captive portal, so we need to install the packages for it.</p>\r\n<p>We also need a web server (Apache2), a database server (MySQL), a scripting language to process requests (perl or php) and the Free Radius authentication server<em>.<br />\r\n</em></p>\r\n<p><em>$ sudo apt-get install mysql-client mysql-server</em><br />\r\n<em> $ sudo apt-get install freeradius freeradius-utils freeradius-mysql</em><br />\r\n<em> $ sudo apt-get install apache2 openssl perl         </em></p>\r\n<p>We need 2 interfaces, one that connects to the internet and another that is used by CoovaChilli to manage our hotspot clients.\r\nWe can use either 2 ethernet cables or an ethernet cable and a wifi dongle, the steps to be followed for either method is discussed below. <br>\r\nIf we use a wireless dongle as the interface that connects to the internet, and an ethernet cable that is managed by CoovaChilli : </p>\r\n<p>Back up every file before modifying it. (Just in case there&#8217;s a problem later and the original files are needed)</p>\r\n<p><em>wlan0</em> represents the wireless dongle and<em> eth0</em> represents the wired connection.<br />\r\nWe need to make a few modifications to the /etc/network/interfaces file.</p>\r\n<p><em>$ sudo nano /etc/network/interfaces</em></p>\r\n<p>Make the following changes to the eth0 and wlan0 interfaces</p>\r\n<p><em>auto eth0</em><br />\r\n<em>iface eth0 inet static</em><br />\r\n<em>                address 10.1.1.1</em><br />\r\n<em>                netmask 255.255.255.0</em><br />\r\n<em>                network 10.1.1.0</em></p>\r\n<p><em>auto wlan0</em><br />\r\n<em>allow-hotplug wlan0</em><br />\r\n<em>iface wlan0 inet manual</em><br />\r\n<em>wpa-roam /etc/wpa_supplicant/wpa_supplicant.conf</em><br />\r\n<em>iface wlan0 inet dhcp</em><br />\r\n<em>                wpa-ssid “<SSID>”</em><br />\r\n<em>                wpa-psk “<Password></em>”</p>\r\n<p>Note that the <em>SSID</em> and <em>Password</em> are from your internet-connected router.</p>\r\n<p>We now need to change the <em>wpa_supplicant.conf</em> file :</p>\r\n<p><em>$ sudo nano /etc/wpa_supplicant/wpa_supplicant.conf</em></p>\r\n<p>We need this in the file :</p>\r\n<p><em>network={</em><br />\r\n<em> ssid=”SSID”</em><br />\r\n<em> psk=”Password”</em><br />\r\n<em> proto=RSN</em><br />\r\n<em> key-mgmt=WPA-PSK</em><br />\r\n<em> pairwise=CCMP</em><br />\r\n<em> auth_alg=OPEN</em><br />\r\n<em> }</em></p>\r\n<p>Now we can go ahead and restart the networking service or reboot the pi.<br />\r\n(Restart n/w service &#8212;&gt; <em>$</em> <em>sudo /etc/init.d/networking restart</em>)</p>\r\n<p>Run <em>ifconfig</em> to make sure that <em>eth0</em> now has a static IP of 10.1.1.1</p>\r\n<p>If we use 2 ethernet cables :</p>\r\n<p><em>$ sudo nano /etc/network/interfaces</em></p>\r\n<p>Make the following changes to the eth0 and eth1 interfaces</p>\r\n<p><em>auto eth0</em><br />\r\n<em>iface eth0 inet static</em><br />\r\n<em>                address 10.1.1.1</em><br />\r\n<em>                netmask 255.255.255.0</em><br />\r\n<em>                network 10.1.1.0</em></p>\r\n<p><em>auto eth1</em><br />\r\n<em>allow-hotplug eth1</em><br />\r\n<em>iface eth1 inet dhcp</em><br /></p>\r\n<p>Now we can go ahead and restart the networking service or reboot the pi.<br />\r\n(Restart n/w service &#8212;&gt; <em>$</em> <em>sudo /etc/init.d/networking restart</em>)</p>\r\n<p>Run <em>ifconfig</em> to make sure that <em>eth0</em> now has a static IP of 10.1.1.1</p>\r\n<p>Now we configure MySQL:</p>\r\n<p>We create an empty database for Free Radius in MySQL called <em>radius.</em></p>\r\n<p><em>$ mysql -u root -p -h localhost</em></p>\r\n<p>Enter the password set during installation, then create the database.</p>\r\n<p><em>mysql&gt; create database radius;</em></p>\r\n<p>Now, exit mysql and import <em>schema.sql</em> from <em>sql/mysql</em> to the database. Note that this can be done from within the <em>mysql</em> directory as a root user.</p>\r\n<p><em># mysql -u root -p radius &lt; schema.sql</em></p>\r\n<p>We can then see the tables using the <em>show tables</em> command within <em>mysql </em></p>\r\n<p>Now, we configure the radius server. We need to add an entry in /etc/freeradius/clients.conf for the local network. Remember to use the correct network.</p>\r\n<p><em>/etc/freeradius/# cat clients.conf</em></p>\r\n<p>Uncomment the line <em>$INCLUDE sql.conf</em></p>\r\n<p>Now we modify the <em>freeradius/sites-available/default</em> file to add <em>sql</em> to the <em>authorize</em>, <em>accounting</em>, <em>session</em> and <em>post-auth</em> sections.</p>\r\n<p><em># nano /etc/freeradius/sites-available/default</em></p>\r\n<p>Uncomment the <em>sql</em> line in each of the blocks.</p>\r\n<p>Now we can test to see if freeradius is configured properly.</p>\r\n<p><em># /usr/sbin/freeradius -X<br />\r\nNOTE that if an error binding port message is received, we need to use the ps -aux command to find the pid of running radius process and use kill -9 PID and execute above command again</em>.</p>\r\n<p>It should now be ready to process requests. Now, open up another terminal.<br />\r\n<em># radtest user1 password localhost 0 testing123</em></p>\r\n<p>This should output the following line :</p>\r\n<pre>rad_recv: <strong>Access-Accept</strong> packet from host 127.0.0.1 port ..., id= ..., length= ...</pre>\r\n<p>In case of any error, make sure that the user and password are entered correctly.</p>\r\n<p>Now, we install CoovaChili in <em>/usr/src , </em>within this directory, execute the command :</p>\r\n<p><em># wget <a href=\"http://ap.coova.org/chilli/coova-chilli-1.3.0.tar.gz\" rel=\"nofollow\">http://ap.coova.org/chilli/coova-chilli-1.3.0.tar.gz</a></em></p>\r\n<p>Unpack the file :</p>\r\n<p><em>/usr/src # tar xzf coova-chilli-1.3.0.tar.gz</em></p>\r\n<p>Enter the newly created <em>coova-chilli-1.3.0</em> directory, we are now ready to configure the source code.</p>\r\n<p><em>$ cd /usr/src/coova-chilli-1.3.0</em><br />\r\n(As a normal user)</p>\r\n<p><em>$ ./configure &#8211;prefix=/usr</em><br />\r\n<em> &#8211;mandir=\\$${prefix}/share/man &#8211;infodir=\\$${prefix}/share/info \\</em><br />\r\n<em> &#8211;sysconfdir=/etc &#8211;localstatedir=/var &#8211;enable-largelimits \\</em><br />\r\n<em> &#8211;enable-binstatusfile &#8211;enable-statusfile &#8211;enable-chilliproxy \\</em><br />\r\n<em> &#8211;enable-chilliradsec &#8211;enable-chilliredir &#8211;with-openssl &#8211;with-curl \\</em><br />\r\n<em> &#8211;with-poll &#8211;enable-dhcpopt &#8211;enable-sessgarden &#8211;enable-dnslog \\</em><br />\r\n<em> &#8211;enable-ipwhitelist &#8211;enable-redirdnsreq &#8211;enable-miniconfig \\</em><br />\r\n<em> &#8211;enable-libjson &#8211;enable-layer3 &#8211;enable-proxyvsa &#8211;enable-miniportal \\</em><br />\r\n<em> &#8211;enable-chilliscript &#8211;enable-eapol &#8211;enable-uamdomainfile \\</em><br />\r\n<em> &#8211;enable-modules &#8211;enable-multiroute</em></p>\r\n<p>Set the compatibility level to 9 to prevent an unstable <em>.deb</em> file.</p>\r\n<p><em>$ echo 9 &gt; debian/compat</em></p>\r\n<p>We next modify the <em>/usr/src/coova-chilli-1.3.0/debian/rules </em>to ensure that the necessary files are placed in the <em>/etc/chilli</em> directory instead of the one specified.</p>\r\n<p><em>$ sudo nano /usr/src/coova-chilli-1.3.0/debian/rules</em></p>\r\n<p>Replace the line :<br />\r\n<em>$(MAKE) DESTDIR=$(CURDIR)/debian/tmp install</em><br />\r\nwith :<br />\r\n<em>$(MAKE) DESTDIR=/ install</em></p>\r\n<p>We compile the source code into a <em>.deb</em> file.</p>\r\n<p><em>/usr/src/coova-chilli-1.3.0 $ sudo dpkg-buildpackage –us –uc</em></p>\r\n<p>After this completes, we install the new<em> .deb</em> file.</p>\r\n<p><em>/usr/src $ sudo dpkg –i coova-chilli_1.3.0_armhf.deb</em></p>\r\n<p>We are then presented with a few options, select the default, <em>N</em>. After this, we get an error, &#8220;no such device&#8221;, this is because CoovaChilli hasn&#8217;t been configured yet.</p>\r\n<p>We now need haserl to create the cgi web scripts.</p>\r\n<p><em>/usr/src $ sudo wget <a href=\"http://downloads.sourceforge.net/project/haserl/haserl-devel/haserl-0.9.30.tar.gz\" rel=\"nofollow\">http://downloads.sourceforge.net/project/haserl/haserl-devel/haserl-0.9.30.tar.gz</a></em></p>\r\n<p><em>/usr/src $ sudo tar xzf haserl-0.9.30.tar.gz</em></p>\r\n<p><em> /usr/src/haserl-0.9.30 $ ./configure</em></p>\r\n<p><em> /usr/src/haserl-0.9.30 $ sudo make &amp;&amp; sudo make install</em></p>\r\n<p>We configure CoovaChilli.</p>\r\n<p><em># nano /etc/default/chilli</em></p>\r\n<p>We change the 0 to a 1 in the 1st line.</p>\r\n<p><em>START_CHILLI = 1</em></p>\r\n<p>Next, we edit the main config file. We assume that 2 ethernet cables are used. Navigate to <em>/etc/chilli </em>and create a copy of the defaults file and name it config</p>\r\n<p><em># nano /etc/chilli/config</em></p>\r\n<p><em>HS_WANIF = eth1<br />\r\n</em></p>\r\n<p><em>HW_LANIF = eth0<br />\r\n</em></p>\r\n<p><em>HS_NETWORK = 10.1.1.0<br />\r\n</em></p>\r\n<p><em>HS_UAMLISTEN = 10.1.1.1<br />\r\n</em></p>\r\n<p><em>HS_DNS1 = 8.8.8.8                            # Google DNS server<br />\r\n</em></p>\r\n<p><em>HS_UAMALLOW = 10.1.1.0/24</em></p>\r\n<p><em>HS_RADSECRET = testing123       # Can change later,needs to be changed in /etc/freeradius/clients.conf as well</em></p>\r\n<p><em>HS_LOC_NAME = “Guest AP”       # Name on login page<br />\r\n</em></p>\r\n<p>We use <em>iptables</em> to configure the firewall.</p>\r\n<p>Create<em> /etc/chilli/ipup.sh</em> with the following line :<br />\r\n<em>iptables -I POSTROUTING -t nat -0 $HS_WANIF -j MASQUERADE</em></p>\r\n<p>Add the path to haserl :</p>\r\n<p><em>$ sudo nano /etc/chilli/wwwsh</em></p>\r\n<p><em>haserl = $(which haserl 2&gt;/dev/null)</em> is replaced with:</p>\r\n<p><em>haserl = /usr/local/bin/haserl</em></p>\r\n<p>Now, we can start CoovaChilli (after a reboot, if so desired, as all services need to be restarted)</p>\r\n<p><em>$ sudo /etc/init.d/chilli start</em></p>\r\n<p>There should be a new interface,<em> tun0</em>, than can be checked with <em>ifconfig.</em></p>\r\n<p>Now, after disabling the DHCP server on the router, setting up your <em>SSID</em> and disabling any firewall security on the router, plug in an ethernet cable from the Raspberry pi to a LAN port, check to make sure that the wireless dongle is receiving an internet signal (from another router, else DHCP conflicts) and connect to the newly created network with another device, it should redirect to the Coova login page.<br />\r\nThe only user as of now is user1 with the password &#8216;password&#8217;.</p>\r\n<p>Now, for a custom page for the captive portal :</p>\r\n<p>Create a new directory in <em>/var/www</em> and call it<em> uam</em>.</p>\r\n<p>We modify <em>/etc/chilli/config</em></p>\r\n<p>HS_UAMSERVER=10.101.100.72</p>\r\n<p>HS_UAMFORMAT=http://\\$HS_UAMSERVER/uam/</p>\r\n<p>HS_UAMHOMEPAGE=http://\\$HS_UAMLISTEN:\\$HS_UAMPORT/www/coova.html</p>\r\n<p>Use the following link and save the file as index.html, and save it in /var/www/uam</p>\r\n<p><a href=\"http://dev.coova.org/svn/coova-chilli/doc/hotspotlogin.html\" target=\"_blank\">HTML using JSON interface</a></p>\r\n<p>Create a file, chilli.js in the same directory with the following contents:<br />\r\n<em>if (navigator.appVersion.indexOf(&#8220;MSIE&#8221;)!=-1)</em><br />\r\n<em>document.write(&#8220;&lt;script type=&#8217;text/javascript&#8217; id=&#8217;chillicontroller&#8217;&gt;&lt;/script&gt;&#8221;);</em></p>\r\n<p><em>if (!window.queryObj) {</em><br />\r\n<em>    window.queryObj = new Object();</em><br />\r\n<em>    window.location.search.replace(new RegExp(&#8220;([^?=&amp;]+)(=([^&amp;]*))?&#8221;,&#8221;g&#8221;), function($0,$1,$2,$3) { queryObj[$1] = $3; });</em><br />\r\n<em>}</em></p>\r\n<p><em>if (queryObj[&#8216;uamip&#8217;] != null &amp;&amp; queryObj[&#8216;uamport&#8217;] != null) {</em><br />\r\n<em>    var script = document.getElementById(&#8216;chillicontroller&#8217;);</em><br />\r\n<em>    if (script == null) {</em><br />\r\n<em>    script = document.createElement(&#8216;script&#8217;);</em><br />\r\n<em>    script.id = &#8216;chillicontroller';</em><br />\r\n<em>    script.type = &#8216;text/javascript';</em><br />\r\n<em>        script.src = &#8216;<a href=\"http://&#8217;+queryObj%5B&#8216;uamip&#8217;%5D+\" rel=\"nofollow\">http://&#8217;+queryObj%5B&#8216;uamip&#8217;%5D+</a>':&#8217;+queryObj[&#8216;uamport&#8217;]+&#8217;/www/chillijs.chi';</em></p>\r\n<p><em>        var head = document.getElementsByTagName(&#8220;head&#8221;)[0];</em><br />\r\n<em>        if (head == null) head = document.body; </em><br />\r\n<em>    head.appendChild(script);</em><br />\r\n<em>    }</em><br />\r\n<em>    script.src = &#8216;<a href=\"http://&#8217;+queryObj%5B&#8216;uamip&#8217;%5D+\" rel=\"nofollow\">http://&#8217;+queryObj%5B&#8216;uamip&#8217;%5D+</a>':&#8217;+queryObj[&#8216;uamport&#8217;]+&#8217;/www/chillijs.chi';</em><br />\r\n<em>} else {</em><br />\r\n<em>    var noLocation = document.getElementById(&#8220;noLocation&#8221;);</em><br />\r\n<em>    if (noLocation != null &amp;&amp; noLocation.style) {</em><br />\r\n<em>       noLocation.style.display = &#8216;inline';</em><br />\r\n<em>    }</em><br />\r\n<em>}</em></p>\r\n<p>Now, we can restart CoovaChilli and the changes should be seen.</p>\r\n<p>To enable CoovaChilli to start at boot time:</p>\r\n<p>Edit the following file:<br />\r\n<em>$ sudo /etc/init.d/chilli</em></p>\r\n<p><em># Provides: chilli</em><br />\r\n<em> # Required-Start: $network</em><br />\r\n<em> # Should-Start:</em><br />\r\n<em> # Required-Stop: $network</em><br />\r\n<em> # Should-Stop:</em><br />\r\n<em> # Default-Start: 2 3 4 5</em><br />\r\n<em> # Default-Stop: 0 1 6</em><br />\r\n<em> # Description: CoovaChilli access controller</em></p>\r\n<p>Then,enter the following command:<br />\r\n<em>$ sudo update-rc.d chilli defaults</em></p>\r\n<p>Adding Azure MFA to the mix :</p>\r\n<p>Create an Azure account and an MFA service. Download the required SDK from the<em> Manage</em> page and set it up, an example has been shown on the GitHub page.</p>\r\n<p>For further reference, code present on GitHub page</p>\r\n\t\t\t\t\t","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}